name: Build and Deploy Writerside Docs

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  DOCKER_VERSION: '2025.04.8412'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build group using Writerside Docker builder
        uses: JetBrains/writerside-github-action@v4
        with:
          instance: 'Writerside/writerside.cfg'
          is-group: true
          docker-version: ${{ env.DOCKER_VERSION }}

      - name: Check artifacts directory
        run: ls -R artifacts

      - name: Save artifact with build results
        uses: actions/upload-artifact@v4
        with:
          name: docs-group
          path: |
            artifacts/*.zip
            artifacts/report.json
          retention-days: 7

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download group docs artifact
        uses: actions/download-artifact@v4
        with:
          name: docs-group
          path: '.'

      - name: Unzip all webhelp zips
        shell: bash
        run: |
          shopt -s nullglob
          mkdir -p dir
          # Find ZIPs whether they were saved under artifacts/ or flattened to the current dir
          zips=(artifacts/*.zip *.zip)
          found=()
          for z in "${zips[@]}"; do
            if [ -f "$z" ]; then
              found+=("$z")
            fi
          done
          if [ ${#found[@]} -eq 0 ]; then
            echo "No ZIP artifacts found in either artifacts/*.zip or *.zip"
          else
            echo "Unzipping the following artifacts:" "${found[@]}"
            for z in "${found[@]}"; do
              unzip -O UTF-8 -oq "$z" -d dir
            done
          fi

      - name: Flatten group output into dir if nested
        shell: bash
        run: |
          shopt -s nullglob dotglob
          if [ ! -f dir/index.html ]; then
            # If there's exactly one subfolder in dir/ that contains index.html, move its content up
            candidates=()
            for d in dir/*/; do
              [ -f "${d}index.html" ] && candidates+=("$d")
            done
            if [ ${#candidates[@]} -eq 1 ]; then
              d="${candidates[0]%/}"
              echo "Flattening $d into dir/"
              mv "$d"/* dir/
              rm -rf "$d"
            fi
          fi


      - name: Rewrite URLs for GitHub Pages (idempotent + starter pages)
        shell: bash
        run: |
          set -euo pipefail
          BASE="/${GITHUB_REPOSITORY#*/}/"
          echo "Rewriting URLs to use base: $BASE"
          if [ "$BASE" != "/" ]; then
            export BASE

            # 1) HTML attributes href/src/content that start with "/" and are NOT already prefixed with BASE
            find dir -type f -name "*.html" -print0 | xargs -0 -I{} perl -0777 -i -pe '
              BEGIN{ $b=$ENV{BASE} }
              s{\b(href|src|content)="(/[^\"]*)"}{
                my ($a,$p)=($1,$2);
                $p = ($p =~ /^\Q$b\E/) ? $p : ($p =~ s{^/}{$b}r);
                qq{$a="$p"}
              }ge
            ' "{}"

            # 2) <base href="/"> -> <base href="$BASE">
            find dir -type f -name "*.html" -print0 | xargs -0 -I{} perl -0777 -i -pe 'BEGIN{ $b=$ENV{BASE} } s{<base\s+href="/(?!/)}{<base href="$b"}gi' "{}"

            # 3) JS/JSON string literals starting with "/" and NOT already prefixed with BASE
            find dir -type f \( -name "*.js" -o -name "*.json" -o -name "*.html" \) -print0 | xargs -0 -I{} perl -0777 -i -pe '
              BEGIN{ $b=$ENV{BASE} }
              s{(["\x27`])(/[^"\x27`)]*)}{
                my ($q,$p)=($1,$2);
                my $np = ($p =~ /^\Q$b\E/) ? $p : ($p =~ s{^/}{$b}r);
                $q.$np
              }ge
            ' "{}"

            # 4) CSS url(/...) -> url($BASE...) if not already prefixed
            find dir -type f -name "*.css" -print0 | xargs -0 -I{} perl -0777 -i -pe '
              BEGIN{ $b=$ENV{BASE} }
              s{url\(\s*(/[^)\s]+)\s*\)}{
                my $p=$1; my $np = ($p =~ /^\Q$b\E/) ? $p : ($p =~ s{^/}{$b}r);
                "url($np)"
              }ge
            ' "{}"

            # 5) Normalize accidental double slashes after BASE
            find dir -type f \( -name "*.html" -o -name "*.js" -o -name "*.css" -o -name "*.json" \) -print0 | xargs -0 -I{} perl -0777 -i -pe 'BEGIN{ $b=$ENV{BASE} } s{\Q$b\E//}{$b}g' "{}"

            # 6) Expand instance root links to starter page slugs (avoid if already present)
            find dir -type f \( -name "*.html" -o -name "*.js" -o -name "*.json" \) -print0 | xargs -0 -I{} perl -0777 -i -pe '
              BEGIN{ $b=$ENV{BASE}; %m=(
                hi=>"default-topic",
                engineering=>"engineering",
                estimating=>"estimating",
                innergy=>"innergy",
                "project-management"=>"project-management"
              ); }
              s{(\Q$b\E)(hi|engineering|estimating|innergy|project-management)(?!/(?:default-topic|engineering|estimating|innergy|project-management))(?=(?:["\x27\)`\s#?]|/\s*["\x27\)`\s#?]|$))}{$1.$2."/".$m{$2}}eg
            ' "{}"

          else
            echo "BASE is '/', skipping rewrite."
          fi

      - name: List site structure (debug)
        shell: bash
        run: |
          echo "Listing top-level of dir/:"; ls -la dir || true
          echo "Listing instance directories:"; for d in hi engineering estimating innergy project-management; do if [ -d "dir/$d" ]; then echo "== $d =="; ls -la "dir/$d" | sed 's/^/    /'; fi; done
          echo "Index files found:"; find dir -maxdepth 2 -type f -name index.html -print | sed 's/^/  /'

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'dir'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
